(()=>{"use strict";const e="http://localhost:7070",t=async t=>{if("POST"===t.requestMethod){const n={method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}},s=await fetch(e+"?method="+t.method,n);if(s.ok){return await s.json()}console.error("Error:",s.status,s.statusText)}if("GET"===t.requestMethod){let n=e;n+=`?method=loadMessages&offset=${t.offset}&limit=${t.limit}`;const s={method:t.requestMethod},o=await fetch(n,s);if(o.ok){const e=await o.json();return console.log(e),e}console.error("Error:",o.status,o.statusText)}},n=async e=>{const t={method:"POST",body:e};try{const e=await fetch("http://localhost:7070/api/messages/file",t);if(e.ok){return await e.json()}{const t=await e.text();return console.error("Error:",e.status,e.statusText,t),null}}catch(e){return console.error("Fetch error:",e),null}};(new class{constructor(){this.containerContent=document.querySelector(".container-content"),this.geoBtn=document.querySelector(".header-geo"),this.messageInput=document.querySelector(".footer-messageInput"),this.enterBtn=document.querySelector(".footer-enterBtn"),this.uploadFile=document.querySelector(".footer-uploadFile"),this.uploadFileInput=this.uploadFile.querySelector(".overlapped"),this.recordAudio=document.querySelector(".header-recordAudio"),this.recordVideo=document.querySelector(".header-recordVideo"),this.recordAudioContainer=document.querySelector(".header-recordContainer"),this.deleteBtn=document.querySelector(".header-deleteMessages")}init(){this.addTextListener(),this.addFileListener(),this.geolocationListener(),this.audioRecordListener(),this.videoRecordListener(),this.deleteBtnListener(),this.allMessagesLoaded=!1,this.loadMessages(),this.setupScrollListener(),this.pinListener()}addTextListener(){const e=()=>{if(""!==this.messageInput.value||void 0!==this.messageInput.value){const e={value:this.messageInput.value,type:"text",method:"createTextMessage",requestMethod:"POST"},n=t(e);n&&n.then((e=>{const t=e.responseMessage;this.addTextMessage(t),this.chaos(t)})),this.messageInput.value=""}};this.enterBtn.addEventListener("click",(()=>{e()})),this.messageInput.addEventListener("keydown",(t=>{"Enter"===t.key&&e()}))}addFileListener(){this.uploadFile.addEventListener("click",(e=>{this.uploadFileInput.dispatchEvent(new MouseEvent("click"))})),this.dndFile(),this.uploadFileInput.addEventListener("change",(e=>{const t=this.uploadFileInput.files[0];if(!t)return;const s=t.type.split("/")[0],o=new FormData;o.append("file",t),o.append("fileType",s),o.append("method","createFileMessage"),o.append("requestMethod","POST"),n(o).then((e=>{console.log(e.responseMessage);const t=e.responseMessage;this.addContent(t,s)}))}))}dndFile(){this.containerContent.addEventListener("dragover",(e=>{e.preventDefault()})),this.containerContent.addEventListener("drop",(e=>{e.preventDefault();const t=e.dataTransfer.files[0],s=t.type.split("/")[0];if(!t)return;const o=new FormData;o.append("file",t),o.append("fileType",s),o.append("method","createFileMessage"),o.append("requestMethod","POST"),n(o).then((e=>{console.log(e.responseMessage);const t=e.responseMessage;this.addContent(t,s)}))}))}addContent(e,t,n=!1){let s;const o=new Uint8Array(e.value),i=new Blob([o],{type:e.fileType}),a=URL.createObjectURL(i);"audio"===t?(s=document.createElement("audio"),s.controls=!0,s.src=a):"video"===t?(s=document.createElement("video"),s.controls=!0,s.src=a):(s=document.createElement("img"),s.src=a),s.className="content-"+t;const r=document.createElement("div");r.className="content-fileContainer",r.append(s),n?this.containerContent.prepend(r):this.containerContent.append(r),s.addEventListener("load",(()=>{URL.revokeObjectURL(a)}))}addTextMessage(e,t=!1){if(""===e)return;const n=document.createElement("div");n.className="content-message";const s=/(https?:\/\/[^\s]+)/g,o=e.match(s),i=e.split(s);n.innerHTML="",i.forEach(((e,t)=>{if(0===t)n.appendChild(document.createTextNode(e));else{const e=document.createElement("a");e.href=o[t-1],e.textContent=o[t-1],e.target="_blank",n.appendChild(e)}})),t?this.containerContent.prepend(n):this.containerContent.append(n)}chaos(e){if("@chaos: погода"===e){const e=function(){const e=["Братик! Ты мой любимый герой! Не забудь надеть свою мантию, чтобы выглядеть как настоящий волшебник!","Братик! За окном дождик, как в романтическом аниме. Давай возьмем зонт и устроим веселую прогулку!","Братик! Помни, даже в трудные моменты мы, как настоящие герои, справимся вместе. Я всегда рядом с тобой!","Братик! Давай сделаем сегодняшний день особенным, как в нашем любимом аниме. Ты знаешь, что ты для меня — всё!","Братик! Ты мой маленький дракон! Надень свой лучший наряд, чтобы покорить мир, как наш любимый персонаж!"];return e[Math.floor(Math.random()*e.length)]}(),n=t({value:e,type:"text",method:"createTextMessage",requestMethod:"POST"});n&&n.then((e=>{const t=e.responseMessage;this.addTextMessage(t)}))}}async navigator(){if(navigator.geolocation)try{const e=await new Promise(((e,t)=>{navigator.geolocation.getCurrentPosition(e,t,{enableHighAccuracy:!0})})),{latitude:n,longitude:s}=e.coords,o=t({latitude:n,longitude:s,type:"coords",method:"createGeoMessage",requestMethod:"POST"});o&&o.then((e=>{const t=e.responseLatitude,n=e.responseLongitude,s=document.createElement("div");s.textContent=`[${t}, ${n}]`,s.className="content-message",this.containerContent.append(s)}))}catch(e){console.log(e)}}async geolocation(){await this.navigator()}geolocationListener(){this.geoBtn.addEventListener("click",(()=>{this.geolocation()}))}audioRecordListener(){let e,t,s=[];const o=()=>{e&&"inactive"!==e.state?"paused"===e.state&&e.resume():navigator.mediaDevices.getUserMedia({audio:!0}).then((o=>{t=o,e=new MediaRecorder(o),e.addEventListener("dataavailable",(e=>{s.push(e.data)})),e.addEventListener("stop",(()=>{if(s.length>0){const e=new Blob(s,{type:"audio/wav"}),o=new File([e],"recorded_audio.wav",{type:"audio/wav"}),i=new FormData;i.append("file",o),i.append("fileType","audio"),i.append("method","createFileMessage"),i.append("requestMethod","POST"),n(i).then((e=>{const t=e.responseMessage;this.addContent(t,"audio")})),t.getTracks().forEach((e=>e.stop()))}s=[]})),e.start(),this.recordAudio.classList.add("record-active")})).catch((e=>{console.error("Error accessing media devices.",e)}))},i=()=>{e&&"recording"===e.state&&(e.stop(),this.recordAudio.classList.remove("record-active"))};this.recordAudio.addEventListener("click",(()=>{this.recordAudio.classList.contains("record-active")?i():o()}))}videoRecordListener(){let e,t,s=[];const o=()=>{e&&"inactive"!==e.state?"paused"===e.state&&e.resume():navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then((o=>{t=o,e=new MediaRecorder(o),e.addEventListener("dataavailable",(e=>{s.push(e.data)})),e.addEventListener("stop",(()=>{if(s.length>0){const e=new Blob(s,{type:"video/webm"}),o=new File([e],"recorded_video.webm",{type:"video/webm"}),i=new FormData;i.append("file",o),i.append("fileType","video"),i.append("method","createFileMessage"),i.append("requestMethod","POST"),n(i).then((e=>{const t=e.responseMessage;console.log(t),this.addContent(t,"video")})),t.getTracks().forEach((e=>e.stop()))}s=[]})),e.start(),this.recordVideo.classList.add("record-active")})).catch((e=>{console.error("Error accessing media devices.",e)}))},i=()=>{e&&"recording"===e.state&&(e.stop(),this.recordVideo.classList.remove("record-active"))};this.recordVideo.addEventListener("click",(()=>{this.recordVideo.classList.contains("record-active")?i():o()}))}deleteBtnListener(){this.deleteBtn.addEventListener("click",(()=>{t({value:"deleteMessages",method:"deleteMessages",requestMethod:"POST"}).then((e=>{"success"===e.responseMessage?this.containerContent.innerHTML="":console.log("error with deleting messagges")}))}))}loadMessages(e=0,n=10){t({requestMethod:"GET",offset:e,limit:n}).then((e=>{e.length>0?(e.forEach((e=>{if("text"===e.type&&this.addTextMessage(e.value,!0),"audio"!==e.fileType&&"video"!==e.fileType&&"image"!==e.fileType||this.addContent(e,e.fileType,!0),"coords"===e.type){const t=document.createElement("div");t.textContent=`[${e.latitude}, ${e.longitude}]`,t.className="content-message",this.containerContent.prepend(t)}})),e.length<n&&(this.allMessagesLoaded=!0)):this.allMessagesLoaded=!0}))}setupScrollListener(){this.containerContent.addEventListener("scroll",(()=>{if(0===this.containerContent.scrollTop&&!this.allMessagesLoaded){const e=this.containerContent.childElementCount;this.loadMessages(e,10)}}))}pinListener(){this.containerContent.addEventListener("contextmenu",(e=>{(e.target.classList.contains("content-message")||e.target.parentElement.classList.contains("content-fileContainer"))&&(e.preventDefault(),this.showContextMenu(e.pageX,e.pageY,e.target))})),document.addEventListener("click",(e=>{const t=document.getElementById("contextMenu");t&&!t.contains(e.target)&&(t.style.display="none")}))}showContextMenu(e,t,n){const s=document.getElementById("contextMenu");s.style.display="block",s.style.left=`${e}px`,s.style.top=`${t}px`,s.addEventListener("click",(e=>{e.target.classList.contains("context-menu__item")&&("Pin"===e.target.textContent&&(console.log("Pinned item"),this.pinItem(n),console.log(n)),"Close"===e.target.textContent&&(console.log("Closed item"),s.style.display="none"))}),{once:!0})}pinItem(e){this.pinnedItemContainer&&this.pinnedItemContainer.remove();const t=document.createElement("div");t.className="pinnedItemContainer",this.pinnedItemContainer=t;const n=document.createElement("div"),s=document.createElement("button");s.innerHTML="&#10005;",s.className="deletePinnedItemBtn",this.deletePiinedItem=s,t.append(n),t.append(s),e.classList.contains("content-message")?(n.innerHTML="&#128190; &nbsp;"+e.textContent.slice(0,40)+"...",this.pinnedItem=e):(n.innerHTML="&#128190; &nbsp; Saved file",this.pinnedItem=e),this.scrollToPinnedItem(),this.containerContent.prepend(t)}scrollToPinnedItem(){this.pinnedItemContainer.addEventListener("click",(e=>{var t;e.target.classList.contains("deletePinnedItemBtn")?this.pinnedItemContainer.remove():(this.pinnedItem.scrollIntoView({behavior:"smooth"}),(t=this.pinnedItem).classList.add("highlightPinnedMessage"),setTimeout((()=>{t.classList.remove("highlightPinnedMessage")}),2e3))}))}}).init()})();